name: Deploy to Lightsail

on:
  push:
    branches: [main, staging]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: ðŸ” Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

    - name: ðŸš€ Deploy
      env:
        HOST: ${{ secrets.HOST }}
        USER: ${{ secrets.USER }}
      run: |
        BRANCH="${GITHUB_REF##*/}"
        if [[ "$BRANCH" == "main" ]]; then
          PROJECT="live-prod"
          DOMAIN="stream.abte.com.ar"
        else
          PROJECT="live-staging"
          DOMAIN="staging.abte.com.ar"
        fi

        ssh -i ~/.ssh/id_ed25519 $USER@$HOST <<EOF
          set -e
          echo "ðŸ‘‰  Branch: $BRANCH   Project: $PROJECT"

          cd ~/$PROJECT || git clone git@github.com:abteprod/live-stream-landing.git ~/$PROJECT
          cd ~/$PROJECT
          git fetch origin $BRANCH
          git reset --hard origin/$BRANCH

          [[ -f .env ]] || { echo "âŒ .env missing"; exit 1; }

          # export vars del .env + override explÃ­cito
          set -a
          . .env
          set +a
          export DOMAIN=$DOMAIN NGINX_PORT_HTTP=80 NGINX_PORT_HTTPS=443
          export DOLLAR=\$

          echo "ðŸŒ Rendering nginx.conf"
          envsubst < nginx.template.conf > nginx.conf
          head -n 15 nginx.conf

          echo "ðŸ§¼ Docker clean"
          sudo docker compose --project-name $PROJECT down -v
          sudo docker system prune -af --volumes

          echo "ðŸ”¨ Build & up"
          sudo docker compose --project-name $PROJECT up -d --build
        EOF
