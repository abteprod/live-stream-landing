name: Deploy to Lightsail

on:
  push:
    branches:
      - main
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ðŸ” Setup SSH access
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

    - name: ðŸš€ Deploy via SSH
      run: |
        BRANCH="${GITHUB_REF##*/}"

        if [[ "$BRANCH" == "main" ]]; then
          PROJECT_NAME="live-prod"
          DOMAIN="stream.abte.com.ar"
        else
          PROJECT_NAME="live-staging"
          DOMAIN="staging.abte.com.ar"
        fi

        ssh -i ~/.ssh/id_ed25519 ${{ secrets.USER }}@${{ secrets.HOST }} << EOF
          set -e

          cd ~/${PROJECT_NAME} || git clone git@github.com:abteprod/live-stream-landing.git ~/${PROJECT_NAME}
          cd ~/${PROJECT_NAME}
          git checkout $BRANCH
          git pull origin $BRANCH

          echo "âœ… Validating .env"
          if [ ! -f ".env" ]; then
            echo "âŒ .env not found. Aborting."
            exit 1
          fi

          echo "ðŸŒ Generating nginx.conf from template"
          export DOMAIN=$DOMAIN
          export NGINX_PORT_HTTP=80
          export NGINX_PORT_HTTPS=443
          export PROJECT_NAME=$PROJECT_NAME
          envsubst < nginx.template.conf > nginx.conf

          echo "ðŸ§¼ Stopping and cleaning"
          sudo docker-compose --project-name $PROJECT_NAME down
          sudo docker system prune -a --volumes -f

          echo "ðŸ”¨ Rebuilding and starting"
          sudo docker-compose --project-name $PROJECT_NAME build --no-cache
          sudo docker-compose --project-name $PROJECT_NAME up -d
        EOF
